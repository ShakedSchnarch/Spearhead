# Master Handover Protocol: Spearhead 2.0

**Status**: üî¥ **CRITICAL** - System is partially functional but fails the "User Visibility" test.

## üö® The Core Failure

Despite backend services running and database population confirmed (via `init_db.py`), the **Frontend Dashboard remains empty ("0" values)**. The user is frustrated by repeated claims of "it works" when the screen shows otherwise.

**Do NOT claim it works until you see the numbers on the screen.**

## üìâ Known Issues & Missing Features (The "Debt")

### 1. The "Invisible" Data (Legacy Files)

- **Issue**: The user uploaded specific legacy Excel files (e.g., "Week 3"). While `field_mapper.py` ingests them, the **Frontend does not display this specific data**.
- **Requirement**: The Dashboard must show the specific "Gap Analysis" from these files, not just generic "Readiness Scores" generated by our math engine.
- **Missing View**: The "Query" view (searching for specific items like "Mag" or "Knee Pads") is implemented in the backend (`/queries`) but **completely missing from the Frontend UI**.

### 2. The API-UI Disconnect

- **Issue**: `PlatoonView.jsx` receives a response but renders nothing.
- **Suspect**: The JSON keys returned by `IntelligenceService.get_platoon_intelligence` do NOT match what `PlatoonView` components (Gauge/Table) expect.
- **Action**: You must verify the JSON contract line-by-line.

### 3. Reporting Gaps

- **Issue**: The `ExcelExporter` exists but hasn't been visually verified by the user to match the "Commander Style" (RTL, Borders, specific headers).
- **Requirement**: The generated Excel MUST look like a military report, not a CSV dump.

## üó∫Ô∏è Detailed Remediation Plan (Step-by-Step)

### Phase 1: Diagnostics & "First Light"

1.  **Trace the Request**:
    - Add `console.log` in `useIntelligence.js` to print the RAW API response.
    - Run the server, open DevTools, and **capture that JSON**.
2.  **Fix the Props**:
    - Modify `PlatoonView.jsx` to map the _actual_ JSON keys to the component props.
    - _Example_: If API returns `readiness_score` but Component expects `score`, FIX IT.
3.  **Verify Legacy Data**:
    - Check `TabularRepository.py`. Is it actually querying the `tabular_records` table where the generic Excel data lives?
    - Ensure the "Status Tables" component is actually fetching from `/queries` and not `/intelligence` if that's where the data is.

### Phase 2: Missing Features Implementation

1.  **Implement Query UI**:
    - Add a "Search/Filter" bar in the Dashboard.
    - Connect it to `GET /queries/tabular/search?q=...`.
    - Display results in a simple, tactical table.
2.  **Integrate "Raw" Data**:
    - Ensure the "Battalion View" aggregates the _actual_ counts from the imported Excel files (Tanks, Ammo counts) alongside the calculated scores.

### Phase 3: The "Commander" Report

1.  **Visual Polish**:
    - Open `src/spearhead/reporting/styles.py`.
    - Ensure `alignment=Alignment(horizontal='right')` is set for ALL text cells (Hebrew support).
    - Ensure `border=Side(style='thin')` is applied to every single cell in the data range.
2.  **Content Verification**:
    - Generate a report.
    - Ask the user to download it and confirm it replaced their old manual process.

## üó£Ô∏è User Preferences (Strict)

- **Style**: "Tactical", "Authentic IDF". Dark mode, sharp edges, functional.
- **Language**: Hebrew (RTL). technical terms must be accurate (Zivud, Tzelem, etc.).
- **Workflow**: Do not ask "how to do it". Propose a plan, get approval, execute.

## üìú Operational Doctrines (Strict)

### 1. Execution Methodology

- **No Guesswork**: Never modify a file without first reading it (`view_file`).
- **Trace First**: Before fixing a bug (like the visual disconnect), use `console.log` or print statements to trace the data flow. Prove the failure mechanism before applying a fix.
- **Incremental Verification**: Do not batch 10 fixes. Fix one thing (e.g., "Get JSON in console"), verify it, then move to the next.

### 2. Project Scanning & Learning

- **Mandatory Onboarding**: You MUST read `task.md`, `implementation_plan.md`, `src/spearhead/config.py`, and `frontend-app/src/types` BEFORE writing a single line of code.
- **Context Awareness**: Understand the "Tenant Isolation" model in `deps.py`. Ignorance of this will cause auth failures.

### 3. Code Policy

- **Style**: Python (Black/PEP8), React (Functional Components, Hooks).
- **No "Quick Hacks"**: Do not hardcode values to make a test pass. Fix the root cause.
- **Comments**: Explain _WHY_, not _WHAT_.

### 4. Documentation & Commiting

- **Live Documentation**: Update `task.md` and `implementation_plan.md` _simultaneously_ with your code changes.
- **Commit Messages**: Use the "Conventional Commits" format (e.g., `fix(ui): map API keys to PlatoonView props`).
- **Transparency**: If you hit a roadblock, document it in `task.md` immediately.