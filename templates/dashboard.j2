<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ settings.app.name }} | מערכת שו"ב גדודית</title>
    <style>
        {{ css_content | safe }}
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap');
    </style>
    <!-- Fallback for Tailwind/FontAwesome if disconnected (assuming builder injects minified versions if local, else CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="tactical-card m-4 mb-4 p-3 flex justify-between items-center sticky top-4 z-50 bg-zinc-900/95 backdrop-blur-sm">
        <div class="flex items-center gap-4">
            <div class="relative group">
                <!-- Cleaner Logo: Simple Geometry -->
                <div class="h-10 w-10 flex items-center justify-center text-emerald-500 text-xl border-l-2 border-emerald-500">
                    <i class="fa-solid fa-bullseye"></i>
                </div>
            </div>
            <div class="flex flex-col">
                <h1 class="font-['Rubik'] text-xl font-bold tracking-[0.15em] text-white uppercase leading-none">IRON<span class="text-emerald-500">VIEW</span></h1>
                <div class="flex items-center gap-2 text-[0.65rem] text-zinc-500 mt-1 font-mono uppercase">
                    <span>Battalion 74</span>
                    <span class="text-emerald-500">• Online</span>
                </div>
            </div>
        </div>

        <div class="hidden md:flex items-center gap-6">
            <div class="text-right border-r border-zinc-800 pr-6">
                <!-- Date/Time aligned specifically -->
                <div class="text-sm font-mono text-white font-bold">{{ now.strftime('%H:%M') }}</div>
                <div class="text-[0.65rem] text-zinc-500 uppercase">{{ now.strftime('%d %b %Y') }}</div>
            </div>
            <div class="flex gap-3 items-center pl-2">
                <div class="text-right">
                    <div class="text-xs font-bold text-white">סמג"ד</div>
                    <div class="text-[0.6rem] text-zinc-500">פיקוד 74</div>
                </div>
                <!-- Profile Icon: Professional/Minimal -->
                <div class="bg-zinc-800 h-9 w-9 flex items-center justify-center rounded-sm border border-zinc-700">
                    <i class="fa-solid fa-user-shield text-zinc-400 text-sm"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 p-4 pt-0 grid grid-cols-1 xl:grid-cols-4 gap-4">

        <!-- Left Column: KPI & Charts (3/4 width) -->
        <div class="xl:col-span-3 space-y-4">
            
            <!-- KPI Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- KPI 1: Readiness -->
                {% set operational = namespace(count=0) %}
                {% for r in data.reports %}{% if r.readiness.value == 'OPERATIONAL' %}{% set operational.count = operational.count + 1 %}{% endif %}{% endfor %}
                {% set total = data.vehicle_scores | length %}
                {% if total > 0 %}{% set readiness_pct = (operational.count / total * 100) | round(1) %}{% else %}{% set readiness_pct = 0 %}{% endif %}

                <div class="tactical-card p-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-emerald-500 text-opacity-80 group-hover:text-opacity-100 transition">
                            <i class="fa-solid fa-shield-halved text-lg"></i>
                        </div>
                        <span class="text-[0.6rem] font-mono text-zinc-600 border border-zinc-800 px-1">RDY</span>
                    </div>
                    <div class="text-3xl font-bold text-white font-['Rubik'] tracking-tight">{{ readiness_pct }}<span class="text-lg text-zinc-500 ml-1">%</span></div>
                    <div class="text-[0.65rem] text-zinc-400 uppercase tracking-wider mt-1">כשירות מבצעית</div>
                    <div class="w-full bg-zinc-800 h-0.5 mt-3">
                        <div class="bg-emerald-500 h-0.5" style="width: {{ readiness_pct }}%"></div>
                    </div>
                </div>

                <!-- KPI 2: Critical Faults -->
                {% set unavailable = namespace(count=0) %}
                {% for r in data.reports %}{% if r.readiness.value == 'UNAVAILABLE' %}{% set unavailable.count = unavailable.count + 1 %}{% endif %}{% endfor %}
                <div class="tactical-card p-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-rose-500 text-opacity-80 group-hover:text-opacity-100 transition">
                            <i class="fa-solid fa-bolt text-lg"></i>
                        </div>
                        <span class="text-[0.6rem] font-mono text-zinc-600 border border-zinc-800 px-1">CRT</span>
                    </div>
                    <div class="text-3xl font-bold text-white font-['Rubik'] tracking-tight">{{ unavailable.count }}</div>
                    <div class="text-[0.65rem] text-zinc-400 uppercase tracking-wider mt-1">מושבתים קריטי</div>
                    <div class="w-full bg-zinc-800 h-0.5 mt-3">
                        <div class="bg-rose-500 h-0.5" style="width: {{ (unavailable.count / total * 100) if total > 0 else 0 }}%"></div>
                    </div>
                </div>

                <!-- KPI 3: Logistics -->
                 {% set logistics_issues = namespace(count=0) %}
                 {% for r in data.reports %}{% if r.logistics_gap %}{% set logistics_issues.count = logistics_issues.count + 1 %}{% endif %}{% endfor %}
                <div class="tactical-card p-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-amber-500 text-opacity-80 group-hover:text-opacity-100 transition">
                            <i class="fa-solid fa-cube text-lg"></i>
                        </div>
                        <span class="text-[0.6rem] font-mono text-zinc-600 border border-zinc-800 px-1">LOG</span>
                    </div>
                    <div class="text-3xl font-bold text-white font-['Rubik'] tracking-tight">{{ logistics_issues.count }}</div>
                    <div class="text-[0.65rem] text-zinc-400 uppercase tracking-wider mt-1">חוסרי ציוד</div>
                    <div class="w-full bg-zinc-800 h-0.5 mt-3">
                         <!-- Indeterminate bar for logistics -->
                         <div class="bg-amber-500 h-0.5 w-1/3"></div>
                    </div>
                </div>

                <!-- KPI 4: Completion -->
                <div class="tactical-card p-4 relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-blue-500 text-opacity-80 group-hover:text-opacity-100 transition">
                            <i class="fa-solid fa-satellite text-lg"></i>
                        </div>
                        <span class="text-[0.6rem] font-mono text-zinc-600 border border-zinc-800 px-1">DAT</span>
                    </div>
                    <div class="text-3xl font-bold text-white font-['Rubik'] tracking-tight">{{ data.reports | length }}</div>
                    <div class="text-[0.65rem] text-zinc-400 uppercase tracking-wider mt-1">דוחות נקלטו</div>
                    <div class="w-full bg-zinc-800 h-0.5 mt-3">
                        <div class="bg-blue-500 h-0.5 w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Charts & Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Main Chart -->
                <div class="tactical-card p-6 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-chart-simple text-emerald-500"></i> כשירות לאורך זמן
                        </h3>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="readinessChart"></canvas>
                    </div>
                </div>

                <!-- Secondary Chart (Faults Breakdown) -->
                <div class="tactical-card p-6">
                    <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-pie-chart text-blue-500"></i> פילוח תקלות
                    </h3>
                    <div class="h-48 relative flex justify-center items-center">
                         <canvas id="faultChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Table (Priority List) -->
            <div class="tactical-card p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-triangle-exclamation text-rose-500"></i> חריגים לטיפול (Priority List)
                    </h3>
                    <div class="relative">
                        <input type="text" id="vehicle-search" placeholder="חיפוש מס' טנק..." class="bg-zinc-900 border border-zinc-700 rounded-sm px-4 py-1.5 text-sm text-white focus:outline-none focus:border-emerald-500 w-48 font-mono">
                        <i class="fa-solid fa-search absolute left-3 top-2.5 text-zinc-500 text-xs"></i>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="priority-table" class="w-full text-sm text-right border-collapse">
                        <thead>
                            <tr class="text-zinc-400 border-b border-zinc-700">
                                <th class="pb-3 pr-4 font-normal">צלי"ם</th>
                                <th class="pb-3 pr-4 font-normal">פלוגה</th>
                                <th class="pb-3 pr-4 font-normal">סטטוס</th>
                                <th class="pb-3 pr-4 font-normal">תקלות / חוסרים</th>
                                <th class="pb-3 pr-4 font-normal">הערת AI</th>
                            </tr>
                        </thead>
                        <tbody class="text-zinc-300">
                             {% for report in data.reports %}
                             {% if report.readiness.value != 'OPERATIONAL' or report.ai_inference.severity_score >= 50 %}
                            <tr class="group hover:bg-zinc-800 transition-colors border-b border-zinc-800 cursor-pointer" onclick="openVehicleModal('{{ report.vehicle_id }}')">
                                <td class="py-4 px-4 font-mono font-bold text-white">{{ report.vehicle_id }}</td>
                                <td class="py-4 px-4">{{ report.company }}</td>
                                <td class="py-4 px-4">
                                     <span class="status-badge 
                                        {% if report.readiness.value == 'UNAVAILABLE' %}bg-rose-500/10 text-rose-500 border border-rose-500/20
                                        {% elif report.readiness.value == 'DEGRADED' %}bg-amber-500/10 text-amber-500 border border-amber-500/20
                                        {% else %}bg-emerald-500/10 text-emerald-500 border border-emerald-500/20{% endif %}">
                                        {{ report.readiness.heb }}
                                     </span>
                                </td>
                                <td class="py-4 px-4">
                                    {{ report.fault_codes | join(', ') }}
                                    {% if report.logistics_gap %}<span class="text-amber-500">| חסר: {{ report.logistics_gap }}</span>{% endif %}
                                </td>
                                <td class="py-4 px-4 text-xs">
                                    {% if report.ai_inference %}
                                        <span class="{% if report.ai_inference.severity_score >= 80 %}text-rose-400{% else %}text-amber-400{% endif %}">
                                            {{ report.ai_inference.recommended_action }}
                                        </span>
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Intelligence Feed (1/4 width) -->
        <div class="xl:col-span-1 space-y-6">
            
            <!-- AI Terminal Box -->
            <div class="tactical-card ai-terminal p-6 relative h-full flex flex-col">
                <div class="flex items-center gap-3 mb-6 border-b border-zinc-800 pb-4">
                    <div class="text-blue-400">
                        <i class="fa-solid fa-brain"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white">Iron-Intelligence</h3>
                        <p class="text-xs text-blue-400 font-mono">AI Module v4.0</p>
                    </div>
                </div>

                <!-- Feed Items -->
                <div class="space-y-4 flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    
                    <!-- Example Static Item -->
                    <div class="bg-zinc-900 border border-zinc-800 p-4">
                        <div class="flex items-center gap-2 mb-2 text-rose-400 text-xs font-bold uppercase tracking-wider">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            אמינות דיווח
                        </div>
                        <p class="text-sm text-zinc-300 leading-relaxed font-mono">
                            המערכת זיהתה 
                            <span class="text-white font-bold">
                                {% set integrity_issues = namespace(value=0) %}
                                {% for r in data.reports %}{% if r.integrity_flags %}{% set integrity_issues.value = integrity_issues.value + 1 %}{% endif %}{% endfor %}
                                {{ integrity_issues.value }}
                            </span>
                            דיווחים חשודים בצלי"ם שונים.
                        </p>
                    </div>

                    <!-- Dynamic AI Items Loop -->
                    {% for report in data.reports %}
                        {% if report.ai_inference and report.ai_inference.severity_score >= 80 %}
                        <div class="bg-zinc-900 border border-zinc-800 p-4">
                            <div class="flex items-center gap-2 mb-2 text-amber-400 text-xs font-bold uppercase tracking-wider">
                                <i class="fa-solid fa-arrow-trend-down"></i>
                                התרעת שחיקה: {{ report.vehicle_id }}
                            </div>
                            <p class="text-sm text-zinc-300 leading-relaxed font-mono">
                                {{ report.ai_inference.reasoning }}
                                <br>
                                <span class="typing-effect text-emerald-400 text-xs mt-2 block">
                                    > {{ report.ai_inference.recommended_action }}
                                </span>
                            </p>
                        </div>
                        {% endif %}
                    {% endfor %}

                </div>
            </div>
        </div>
    </div>

    </main>

    <!-- Vehicle Inspector Modal -->
    <dialog id="vehicle-modal" class="bg-transparent p-0 w-full max-w-2xl backdrop:bg-zinc-950/80 backdrop:backdrop-blur-sm focus:outline-none">
        <div class="tactical-card p-0 shadow-2xl relative">
            <!-- Modal Header -->
            <div class="bg-zinc-800 p-4 flex justify-between items-center border-b border-zinc-700">
                <div class="flex items-center gap-3">
                    <div class="bg-zinc-900 p-2 rounded-sm border border-zinc-700 text-emerald-500">
                        <i class="fa-solid fa-tank-water"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white font-mono" id="modal-vid">820251</h2>
                        <div class="text-xs text-zinc-400 uppercase tracking-widest">Vehicle Inspector</div>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 grid grid-cols-2 gap-6 bg-zinc-900/95">
                <!-- Left: Status -->
                <div class="space-y-4">
                    <div>
                        <div class="text-xs text-zinc-500 uppercase mb-1">Company</div>
                        <div class="text-white font-bold" id="modal-company">LAVIE</div>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-500 uppercase mb-1">Operational Status</div>
                        <div class="inline-block px-2 py-1 rounded-sm text-xs font-bold font-mono" id="modal-status">OPERATIONAL</div>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-500 uppercase mb-1">Location</div>
                        <div class="text-zinc-300 font-mono" id="modal-location">GRID 349281</div>
                    </div>
                </div>

                <!-- Right: Technical -->
                <div class="space-y-4 border-r border-zinc-800 pr-6">
                    <div>
                        <div class="text-xs text-zinc-500 uppercase mb-1">Active Faults</div>
                        <div class="text-rose-400 font-mono" id="modal-faults">None</div>
                    </div>
                    <div>
                        <div class="text-xs text-zinc-500 uppercase mb-1">Logistics Gaps</div>
                        <div class="text-amber-400 font-mono" id="modal-logistics">None</div>
                    </div>
                    <div class="pt-4 border-t border-zinc-800">
                        <div class="text-xs text-zinc-500 uppercase mb-1">AI Analysis</div>
                        <p class="text-xs text-zinc-400 leading-relaxed" id="modal-ai">
                            System assessment normal. No anomalies detected.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="bg-zinc-800 p-3 text-right">
                <button onclick="closeModal()" class="px-4 py-1.5 bg-zinc-700 hover:bg-zinc-600 text-white text-xs font-bold uppercase rounded-sm transition">
                    Close Terminal
                </button>
            </div>
        </div>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inject Server-Side Data
        window.IRON_DATA = {{ js_reports | tojson }};
        window.FAULT_DATA = {{ fault_breakdown | tojson }};
        window.CHART_LABELS = {{ chart_labels | tojson }};
        window.CHART_VALUES = {{ chart_values | tojson }};
        
        {{ js_content }}

        // Tactical Theme Colors for Charts
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = "'Assistant', sans-serif";

        const ctx = document.getElementById('readinessChart').getContext('2d');
        const readinessChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels | safe }},
                datasets: [{
                    label: 'כשירות (%)',
                    data: {{ chart_values | safe }},
                    borderColor: '#10b981', // Emerald 500
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { borderDash: [2, 4], color: 'rgba(148, 163, 184, 0.1)' },
                        ticks: { callback: function(value) { return value + '%' } }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    </script>
</body>
</html>
